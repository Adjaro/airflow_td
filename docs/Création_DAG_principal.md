# üöÄ √âtape 3 : Cr√©ation d'un pipeline ETL avec Airflow

## üéØ Objectif
Cr√©er un pipeline ETL (Extract, Transform, Load) avec Airflow pour :
1. Extraire des donn√©es de ventes de magasins en France et aux √âtats-Unis.
2. Transformer les donn√©es en convertissant les prix en GBP.
3. Charger les donn√©es transform√©es dans un fichier CSV.

---

## üìö Ressources
- [Documentation officielle d'Airflow](https://airflow.apache.org/docs/)
- [PythonOperator](https://airflow.apache.org/docs/apache-airflow/stable/howto/operator/python.html)
- [Pandas Documentation](https://pandas.pydata.org/docs/)

---

## üìù √âtapes du TD

### √âtape 1 : Configuration initiale

#### Exercice
1. Cr√©ez un fichier `etl_ventes_dag.py` dans le dossier `dags` d'Airflow.
2. Importez les modules n√©cessaires : `DAG`, `PythonOperator`, `datetime`, `timedelta`, `random`, `pandas`, et `os`.
3. Configurez les chemins pour le fichier CSV et cr√©ez le dossier `data` s'il n'existe pas.

#### Ressources utiles
- [Documentation d'Airflow sur les DAGs](https://airflow.apache.org/docs/apache-airflow/stable/concepts/dags.html)
- [Gestion des fichiers avec Python](https://docs.python.org/3/library/os.html)

#### üí° Astuce
- Utilisez `os.getenv` pour r√©cup√©rer le chemin du dossier Airflow.
- Utilisez `os.makedirs` pour cr√©er le dossier `data`.

??? example "Afficher la solution"
    ```python
    from airflow import DAG
    from airflow.operators.python_operator import PythonOperator
    from datetime import datetime, timedelta
    import random
    import pandas as pd
    import os

    # Configuration
    AIRFLOW_HOME = os.getenv('AIRFLOW_HOME', '/opt/airflow')
    DATA_DIR = os.path.join(AIRFLOW_HOME, 'data')
    CSV_FILE = os.path.join(DATA_DIR, 'ventes_transformed.csv')
    os.makedirs(DATA_DIR, exist_ok=True)
    ```

---

### √âtape 2 : Extraction des donn√©es pour la France

#### Exercice
1. D√©finissez un dictionnaire `magasins` contenant les donn√©es des magasins en France.
2. Cr√©ez une fonction `extraction_ventes(magasin_key)` pour g√©n√©rer des ventes al√©atoires pour un magasin donn√©.
3. Ajoutez une fonction `extract_france()` pour extraire les donn√©es des magasins en France.

#### Ressources utiles
- [Manipulation de dictionnaires en Python](https://docs.python.org/3/tutorial/datastructures.html#dictionaries)
- [G√©n√©ration de nombres al√©atoires avec `random`](https://docs.python.org/3/library/random.html)

#### üí° Astuce
- Utilisez `random.choice` pour s√©lectionner al√©atoirement des villes et des noms de magasins.
- Stockez les ventes dans une liste de dictionnaires.

??? example "Afficher la solution"
    ```python
    # Donn√©es des magasins avec prix en devise locale
    magasins = {
        "france": {
            "pays": "France",
            "devise": "EUR",
            "villes": ["Paris", "Lyon"],
            "noms_magasin": ["SuperMart France", "QuickShop France"],
            "produits": {
                "Pommes": 1.30,  # Prix en EUR
                "Bananes": 0.70,
                "Lait": 1.80,
                "Pain": 1.00,
                "≈íufs": 2.20
            },
            "vendeurs": ["Jean", "Marie", "Pierre", "Sophie", "Luc"]
        }
    }

    def extraction_ventes(magasin_key):
        """
        Extrait les donn√©es de vente pour un magasin.
        """
        magasin = magasins[magasin_key]
        ventes = []
        
        for produit, prix_unitaire in magasin["produits"].items():
            for vendeur in magasin["vendeurs"]:
                ville = random.choice(magasin["villes"])
                nom_magasin = random.choice(magasin["noms_magasin"])
                quantite_vendue = random.randint(1, 10)
                prix_total = quantite_vendue * prix_unitaire
                
                ventes.append({
                    "pays": magasin["pays"],
                    "devise_origine": magasin["devise"],
                    "ville": ville,
                    "nom_magasin": nom_magasin,
                    "produit": produit,
                    "prix_unitaire_original": prix_unitaire,
                    "vendeur": vendeur,
                    "quantite_vendue": quantite_vendue,
                    "prix_total_original": prix_total,
                    "date_vente": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                })
        
        return ventes

    def extract_france():
        """Extraction des donn√©es France"""
        return extraction_ventes("france")
    ```

---

### √âtape 3 : Transformation des donn√©es pour la France

#### Exercice
1. D√©finissez un dictionnaire `TAUX_CONVERSION` pour les taux de change EUR ‚Üí GBP et USD ‚Üí GBP.
2. Cr√©ez une fonction `transformation_ventes(ventes, pays)` pour convertir les prix en GBP.
3. Ajoutez une fonction `transform_france()` pour transformer les donn√©es des magasins en France.

#### Ressources utiles
- [Manipulation de listes et dictionnaires en Python](https://docs.python.org/3/tutorial/datastructures.html)
- [Arrondir des nombres avec `round`](https://docs.python.org/3/library/functions.html#round)

#### üí° Astuce
- Utilisez `round` pour arrondir les prix convertis √† 2 d√©cimales.
- Ajoutez un champ `taux_conversion` pour suivre le taux utilis√©.

??? example "Afficher la solution"
    ```python
    # Taux de conversion (simul√©)
    TAUX_CONVERSION = {
        'EUR_TO_GBP': 0.85,  # 1 EUR = 0.85 GBP
        'USD_TO_GBP': 0.79   # 1 USD = 0.79 GBP
    }

    def transformation_ventes(ventes, pays):
        """
        Transforme les donn√©es de vente en convertissant les prix en GBP.
        """
        ventes_transformees = []
        for vente in ventes:
            vente_transformee = vente.copy()
            
            # S√©lectionner le taux de conversion appropri√©
            taux = (TAUX_CONVERSION['EUR_TO_GBP'] 
                    if vente['devise_origine'] == 'EUR' 
                    else TAUX_CONVERSION['USD_TO_GBP'])
            
            # Convertir les prix en GBP
            vente_transformee['prix_unitaire_gbp'] = round(vente['prix_unitaire_original'] * taux, 2)
            vente_transformee['prix_total_gbp'] = round(vente['prix_total_original'] * taux, 2)
            vente_transformee['taux_conversion'] = taux
            vente_transformee['date_transformation'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            ventes_transformees.append(vente_transformee)
        
        print(f"‚úì Transformation des donn√©es de {pays} termin√©e")
        return ventes_transformees

    def transform_france(**context):
        """Transformation des donn√©es France"""
        ventes_france = context['task_instance'].xcom_pull(task_ids='extract_france')
        return transformation_ventes(ventes_france, "France")
    ```

---

### √âtape 4 : Extraction et transformation des donn√©es pour les USA

#### Exercice
1. Ajoutez les donn√©es des magasins aux √âtats-Unis dans le dictionnaire `magasins`.
2. Cr√©ez une fonction `extract_usa()` pour extraire les donn√©es des magasins aux √âtats-Unis.
3. Cr√©ez une fonction `transform_usa()` pour transformer les donn√©es des magasins aux √âtats-Unis.

#### Ressources utiles
- [Documentation sur les dictionnaires Python](https://docs.python.org/3/tutorial/datastructures.html#dictionaries)
- [Utilisation de `random` pour g√©n√©rer des donn√©es al√©atoires](https://docs.python.org/3/library/random.html)

#### üí° Astuce
- Inspirez-vous des fonctions `extract_france()` et `transform_france()`.
- Assurez-vous que les donn√©es sont correctement converties en GBP.

??? example "Afficher la solution"
    ```python
    # Ajout des donn√©es pour les USA
    magasins["usa"] = {
        "pays": "√âtats-Unis",
        "devise": "USD",
        "villes": ["New York", "Los Angeles"],
        "noms_magasin": ["SuperMart USA", "QuickShop USA"],
        "produits": {
            "Pommes": 1.80,  # Prix en USD
            "Bananes": 0.95,
            "Lait": 2.40,
            "Pain": 1.45,
            "≈íufs": 3.00
        },
        "vendeurs": ["Alice", "Bob", "Charlie", "David", "Eve"]
    }

    def extract_usa():
        """Extraction des donn√©es USA"""
        return extraction_ventes("usa")

    def transform_usa(**context):
        """Transformation des donn√©es USA"""
        ventes_usa = context['task_instance'].xcom_pull(task_ids='extract_usa')
        return transformation_ventes(ventes_usa, "USA")
    ```

---

### √âtape 5 : Chargement des donn√©es

#### Exercice
1. Cr√©ez une fonction `load_data()` pour charger les donn√©es transform√©es dans un fichier CSV.
2. Combinez les donn√©es des deux magasins dans un DataFrame Pandas.
3. Sauvegardez le DataFrame dans un fichier CSV.

#### Ressources utiles
- [Documentation de Pandas sur les DataFrames](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html)
- [Manipulation de fichiers CSV avec Pandas](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_csv.html)

#### üí° Astuce
- Utilisez `pd.concat` pour combiner les donn√©es existantes et nouvelles.
- V√©rifiez si le fichier CSV existe d√©j√† avant de l'√©craser.

??? example "Afficher la solution"
    ```python
    def load_data(**context):
        """Chargement des donn√©es transform√©es"""
        try:
            # R√©cup√©rer les donn√©es transform√©es
            ventes_usa = context['task_instance'].xcom_pull(task_ids='transform_usa')
            ventes_france = context['task_instance'].xcom_pull(task_ids='transform_france')
            
            # Combiner les donn√©es
            toutes_ventes = ventes_usa + ventes_france
            
            # Cr√©er le DataFrame
            df = pd.DataFrame(toutes_ventes)
            
            # G√©rer le fichier existant
            if os.path.exists(CSV_FILE):
                df_existant = pd.read_csv(CSV_FILE)
                df = pd.concat([df_existant, df], ignore_index=True)
            
            # Sauvegarder
            df.to_csv(CSV_FILE, index=False)
            print(f"‚úì Donn√©es charg√©es dans {CSV_FILE}")
            print(f"‚úì Nombre total d'enregistrements: {len(df)}")
            
        except Exception as e:
            print(f"‚ùå Erreur lors du chargement: {str(e)}")
            raise
    ```

---

### √âtape 6 : Configuration du DAG

#### Exercice
1. D√©finissez les arguments par d√©faut du DAG.
2. Cr√©ez une instance de DAG avec un intervalle d'ex√©cution de 5 minutes.
3. Ajoutez les t√¢ches d'extraction, de transformation et de chargement.
4. D√©finissez les d√©pendances entre les t√¢ches.

#### Ressources utiles
- [Documentation d'Airflow sur les DAGs](https://airflow.apache.org/docs/apache-airflow/stable/concepts/dags.html)
- [Utilisation de PythonOperator](https://airflow.apache.org/docs/apache-airflow/stable/howto/operator/python.html)

#### üí° Astuce
- Utilisez `PythonOperator` pour les t√¢ches.
- D√©finissez les d√©pendances avec `>>`.

??? example "Afficher la solution"
    ```python
    # Configuration du DAG
    default_args = {
        'owner': 'airflow',
        'depends_on_past': False,
        'start_date': datetime(2024, 1, 1),
        'retries': 1,
        'retry_delay': timedelta(minutes=5),
    }

    # Cr√©ation du DAG
    dag = DAG(
        'etl_ventes_pipeline',
        default_args=default_args,
        description='Pipeline ETL: Extraction ‚Üí Transformation (conversion en GBP) ‚Üí Chargement',
        schedule_interval=timedelta(minutes=5),
        catchup=False,
    )

    # T√¢ches d'extraction
    extract_usa_task = PythonOperator(
        task_id='extract_usa',
        python_callable=extract_usa,
        dag=dag,
    )

    extract_france_task = PythonOperator(
        task_id='extract_france',
        python_callable=extract_france,
        dag=dag,
    )

    # T√¢ches de transformation
    transform_usa_task = PythonOperator(
        task_id='transform_usa',
        python_callable=transform_usa,
        provide_context=True,
        dag=dag,
    )

    transform_france_task = PythonOperator(
        task_id='transform_france',
        python_callable=transform_france,
        provide_context=True,
        dag=dag,
    )

    # T√¢che de chargement
    load_task = PythonOperator(
        task_id='load_data',
        python_callable=load_data,
        provide_context=True,
        dag=dag,
    )

    # D√©finition du flux de donn√©es
    extract_usa_task >> transform_usa_task >> load_task
    extract_france_task >> transform_france_task >> load_task
    ```

---

## üèÜ Conclusion
Vous avez cr√©√© un pipeline ETL complet avec Airflow pour extraire, transformer et charger des donn√©es de ventes. Ce TD vous a permis de comprendre les concepts de base d'Airflow et de construire un workflow robuste.